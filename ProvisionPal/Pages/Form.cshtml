@page "/Form/{FormID:GUID}"
@inject Services.Database DB
@model ProvisionPal.Pages.FormModel
@using System.Data.SqlClient
@using Microsoft.Extensions.Primitives
@using ProvisionPal.Classes

@{
    DB.Connection.Open();
    SqlCommand cmd = DB.Connection.CreateCommand();
    cmd.Parameters.AddWithValue("@FORMID@", Request.RouteValues["FormID"]);
    cmd.CommandText = "SELECT Name, Description FROM Forms WHERE FormID = @FORMID@";
    SqlDataReader reader = cmd.ExecuteReader();
    reader.Read();
    ViewData["Title"] = reader.GetString(0);
    string Description = reader.GetString(1);
    reader.Close();
    cmd.CommandText = "SELECT ParameterID FROM FormXRefParameters WHERE FormID = @FORMID@ ORDER BY [Order] ASC";
    List<Guid> paramIDs = new();
    reader = cmd.ExecuteReader();
    while (reader.Read()) paramIDs.Add(reader.GetGuid(0));
    reader.Close();
    cmd.CommandText = "SELECT ScriptGroupID FROM ScriptGroups WHERE ScriptGroupID IN (SELECT ScriptGroupID FROM FormXRefScriptGroups WHERE FormID = @FORMID@) ORDER BY Name ASC";
    reader = cmd.ExecuteReader();
    List<Guid> sgIDs = new();
    while (reader.Read()) sgIDs.Add(reader.GetGuid(0));
    DB.Connection.Close();

    Dictionary<Guid, string> requestValues = new();

    if (Request.Method == "POST")
    {
        foreach (KeyValuePair<string, StringValues> kvp in Request.Form)
        {
            if (kvp.Key.StartsWith("PARAM-") && Guid.TryParse(kvp.Key.Replace("PARAM-", ""), out Guid paramid))
            {
                if (ParameterUtil.Validate(DB, paramid, kvp.Value[0])) requestValues.Add(paramid, kvp.Value[0]);
            }
            if (kvp.Key.StartsWith("PERM-") && Guid.TryParse(kvp.Key.Replace("PERM-", ""), out Guid permid))
            {
                requestValues.Add(permid, kvp.Value[0]);
            }
        }
    }
}

<div class="container">
    <div class="row justify-content-center">
        <div class="py-5 text-center">
            <h2>@ViewData["Title"]</h2>
            <p class="lead">@Description</p>
        </div>
    </div>
    <div class="row justify-content-center">
        <form class="col-lg-8" method="post">
            <div class="modal fade" id="permsModal" tabindex="-1" aria-labelledby="permsModalLbl" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="permsModalLbl">Select permissions</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-header">
                            <div class="input-group w-100">
                                <span class="input-group-text"><i class="bi bi-filter"></i></span>
                                <input type="text" class="form-control" placeholder="Filter" aria-label="Filter">
                            </div>
                        </div>
                        <div class="modal-body">
                            
                            <div class="list-group">

                                @for(int i = 0; i < 10; i++) {
                                @foreach(Guid sgID in sgIDs)
                                {
                                    string val = null;
                                    requestValues.TryGetValue(sgID, out val);
                                    <component
                                        type="typeof(Shared.Components.SQL.Permission)"
                                        render-mode="Static"
                                        param-ScriptGroupID="sgID"
                                        param-Value="val"
                                    />
                                }
                                }
        
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <h4 class="p-2">Parameters</h4>
            </div>
            <div class="row">
                @foreach(Guid paramID in paramIDs)
                {
                    string val = null;
                    requestValues.TryGetValue(paramID, out val);
                    <div class="col-md-6 p-2">
                        <component
                            type="typeof(Shared.Components.SQL.Parameter)"
                            render-mode="Static"
                            param-ParameterID="paramID"
                            param-Value="val"
                        />
                    </div>
                }
            </div>
            
            <div class="row justify-content-between">
                <h4 class="p-2 col-auto">Permissions</h4>
                <div class="p-2 col-auto">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#permsModal">
                        <i class="bi bi-node-plus"></i> Add
                    </button>
                </div>
            </div>

            <div class="row">
                <ul class="p-2 list-group">
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>A list item</span>
                        <span role="button" class="ms-auto text-primary bi bi-x-circle" title="Remove permission."></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>A list item</span>
                        <span role="button" class="ms-auto text-primary bi bi-x-circle" title="Remove permission."></span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>A list item</span>
                        <span role="button" class="ms-auto text-primary bi bi-x-circle" title="Remove permission."></span>
                    </li>
                </ul>
            </div>

            <div class="row">
                <div class="col p-2">
                    <button class="w-100 btn btn-primary" type="submit">Submit</button>
                </div>
            </div>
        </form>
    </div>
</div>